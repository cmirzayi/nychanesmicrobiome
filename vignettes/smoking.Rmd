---
title: "Tobacco exposure associated with oral microbiome anaerobiosis in the New York City Health and Nutrition Examination Study (NYC HANES) II"
author: "Francesco Beghini"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    fig_caption: yes
    toc: yes
    toc_depth: 2
    number_sections: true
    keep_md: true
vignette: >
  %\VignetteIndexEntry{Tobacco exposure associated with oral microbiome anaerobiosis in the New York City Health and Nutrition Examination Study (NYC HANES) II}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::knitr}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::fig_path('figures')
suppressPackageStartupMessages({
library(phyloseq)
library(dplyr)
library(ggplot2)
library(tidyr)
library(DESeq2)
library(edgeR)
library(reshape2)
library(knitr)
library(phyloseq)
library(GSEABase)
library(magrittr)
library(SummarizedExperiment)
library(nychanesmicrobiome)})

scale_palette <- c("#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00")
theme_transparent <- ggplot2::theme(axis.title = ggplot2::element_text(colour = "white"),
                                    axis.text = ggplot2::element_text(colour = "white"),
                                    title = ggplot2::element_text(colour = "white"),
                                    legend.text = ggplot2::element_text(colour = "white"),
                                    axis.ticks = ggplot2::element_line(colour = "white"),
                                    panel.border = ggplot2::element_rect(colour = "white"),
                                    panel.background = ggplot2::element_rect(fill = "transparent",colour = NA),
                                    plot.background =  ggplot2::element_rect(fill = "transparent",colour = NA),
                                    legend.background = ggplot2::element_rect(fill = "transparent",colour = NA),
                                    legend.key = ggplot2::element_rect(fill = "transparent",colour = NA),
                                    panel.grid = ggplot2::element_blank())

```

<!-- Latest results: -->

<!-- * No rarefy at even dept -->
<!-- * OTU picking with min size = 10 reads/OTU -->
<!-- * Cutoff threshold at 1000 reads/sample -->
<!-- + 26 samples with <1000 reads removed, around the 5% error of PCR failure that Christine told me -->
<!-- + Removal of these samples is done in phyloseq and not during QIIME processing -->

```{r Data loading, message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}
NYC_HANES <- loadQiimeData() %>% annotateFactors(.)
```

# Table 1: Demographics & Descriptive Statistics
```{r Table1, echo=FALSE, message=FALSE, warning=FALSE}
metadata <- data.frame(sample_data(NYC_HANES))

variablesToLook <- c('smokingstatus', "GENDER","RACE","EDU4CAT","SPAGE", "AGEGRP5C","BMI","DBTS_NEW","SR_ACTIVE","SMQ_7","INC25KMOD","POVGROUP6_0812CT","COTININE","MERCURYU","OHQ_5")
factorVars <- c("AGEGRP5C", "RACE","EDU4CAT","DBTS_NEW","SR_ACTIVE","INC25KMOD","POVGROUP6_0812CT", "GENDER")
table1 <- tableone::CreateTableOne(vars = variablesToLook,
                                   data = metadata, 
                                   factorVars = factorVars, 
                                   includeNA = T,
                                   test = T)

alternative_habits <-metadata[metadata$smokingstatus == 'Alternative smoker',c('E_CIGARETTES','HOOKAH_PIPE','CIGARS_CIGARILLOS')] %>% mutate_all(funs(type.convert)) %>% colSums(na.rm = T)

table1_data <- formatMetadata(NYC_HANES)

table1 <- prettytable_autoindent(vars = names(table1_data),data = table1_data, 
                         includeNA = TRUE,test = FALSE)
knitr::kable(table1, format="markdown")
```

```{r Build taxonomy objects, cache=TRUE, include=FALSE}
NYC_HANES.genus <- tax_glom(NYC_HANES,taxrank = "Genus")
NYC_HANES.genus.relab <- transform_sample_counts(NYC_HANES.genus, function(x) x/sum(x))
NYC_HANES.relab <- transform_sample_counts(NYC_HANES, function(x) x/sum(x))

NYC_HANES.genus.relab <- merge_taxa(NYC_HANES.genus, 
                                    taxa_names(filter_taxa(NYC_HANES.genus.relab, function(x) mean(x) < 2e-4, T)))
tax_table(NYC_HANES.genus.relab)[is.na(tax_table(NYC_HANES.genus.relab)[,"Genus"]),"Genus"] <- "Other"
NYC_HANES.genus.relab <- tax_glom(transform_sample_counts(NYC_HANES.genus.relab, function(x) x/sum(x)),taxrank = "Genus")

NYC_HANES.phylum <- tax_glom(NYC_HANES,taxrank = "Phylum")
NYC_HANES.phylum.relab <- transform_sample_counts(NYC_HANES.phylum, function(x) x/sum(x))
```

# Microbial composition (8 most abundant genera)
```{r genus_plot, echo=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.width=12}
plot(plot_abundance(NYC_HANES, top_n = 8, prop="total",taxrank = "Genus") + labs(x="296 oral rinse samples"))
```

# Alpha diversity
```{r Alpha diversity calculation, cache=TRUE, include=FALSE}
alphadiv <- estimate_richness(NYC_HANES, measures = c("Observed","Chao1","Shannon", "Simpson"))[,-3]
alphadiv <- cbind(alphadiv, sample_data(NYC_HANES)$smokingstatus)
colnames(alphadiv)[5] <- c("smokingstatus")

alphadiv.melted <- melt(alphadiv, id.vars = c("smokingstatus"))
```

```{r Alpha diversity boxplots, echo=FALSE, fig.height=8, fig.width=12}
ggplot(alphadiv.melted, aes(smokingstatus,value)) +
  geom_boxplot(aes(fill=smokingstatus))+
  facet_grid(variable ~., scales = "free", switch = 'y') +
  scale_x_discrete(labels = c("Cigarette\nsmokers","Never\nsmokers","Former\nsmokers","Alternative\nsmokers","Secondhand\nsmoke"))+
  scale_y_continuous(position = 'right') +
  scale_fill_manual(values = scale_palette) +
  guides(colour="none") +
  ggtitle("Smoking categories") +
  theme_bw() +
  theme(strip.background = element_rect(colour = "transparent", fill = "transparent"),
        strip.text.y = element_text(angle = 180))
```

```{r ANOVA on alpha diversity measures, cache=FALSE}
aovSMOKINGSTATUS<-aov(Shannon ~ smokingstatus,alphadiv)
summary(aovSMOKINGSTATUS)

aovSMOKINGSTATUS<-aov(Observed ~ smokingstatus,alphadiv)
summary(aovSMOKINGSTATUS)

aovSMOKINGSTATUS<-aov(Chao1 ~ smokingstatus,alphadiv)
summary(aovSMOKINGSTATUS)
```

# Beta Diversity
```{r Calculate distances, warning=FALSE, cache=TRUE, include=FALSE}
distwu <- phyloseq::distance(NYC_HANES, "wunifrac")
ordwu <-  ordinate(NYC_HANES, method = "MDS", distance = distwu, weighted = TRUE)

smoker.wu.data <- plot_ordination(NYC_HANES, ordwu,justDF = T) %>% arrange()

smoker.wu.data$weeksquit <- as.numeric(smoker.wu.data[,"SMQ_4"]) * as.numeric(smoker.wu.data[,"SMQ_4UNIT"])
smoker.wu.data[!smoker.wu.data$SMOKER3CAT %in% "Former smoker","weeksquit"] <- 5
smoker.wu.data$CIGARETTES[is.na(smoker.wu.data$CIGARETTES)] <- "No"

smoker.wu.data %<>% bind_cols(otu_table(NYC_HANES.phylum.relab) %>% t %>% data.frame)
proteobacteria <- tax_table(NYC_HANES.phylum.relab)[tax_table(NYC_HANES.phylum.relab)[,"Phylum"]=="Proteobacteria"] %>% rownames
```

## Cigarette smokers vs Never smokers
```{r pcoa_smokers_neversmoker, echo=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.width=12}
plot(ggplot(subset(smoker.wu.data,smokingstatus  %in% c("Cigarette","Never smoker"))) + 
  geom_point(aes(Axis.1,Axis.2, color=smokingstatus), size=3, alpha=0.7) +
  theme_bw() +
  scale_color_manual(name='Smoking status', values = scale_palette[1:2]) +
  scale_y_continuous(limits = c(-0.14,0.13)) +
  scale_x_continuous(limits = c(-0.18,0.20))
)
```

## Cigarette smokers + Never smokers + Former smokers
```{r pcoa_threecat, echo=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.width=12}
plot(ggplot(subset(smoker.wu.data,smokingstatus  %in% c("Cigarette","Never smoker","Former smoker"))) + 
  geom_point(aes(Axis.1,Axis.2, color=smokingstatus, size=weeksquit), alpha=0.7) +
  theme_bw() +
  scale_color_manual(name='Smoking status', values = scale_palette[c(1:3)]) +
  scale_y_continuous(limits = c(-0.14,0.13)) +
  scale_x_continuous(limits = c(-0.18,0.20)) +
  scale_size(range = c(2,8))
)
```

## Cigarette smokers + Never smokers + Former smokers + Secondhand smokers
```{r pcoa_fourcat, echo=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.width=12}
plot(ggplot(subset(smoker.wu.data,smokingstatus  %in% c("Cigarette","Never smoker","Former smoker","Secondhand"))) + 
  geom_point(aes(Axis.1,Axis.2, color=smokingstatus, size=weeksquit), alpha=0.7) +
  theme_bw() +
  scale_color_manual(name='Smoking status', values = scale_palette[c(1:4)]) +
  scale_y_continuous(limits = c(-0.14,0.13)) +
  scale_x_continuous(limits = c(-0.18,0.20)) +
  scale_size(range = c(2,8))
)
```

## All smoking statuses
```{r pcoa_all, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
plot(ggplot(smoker.wu.data) + 
  geom_point(aes(Axis.1,Axis.2, color=smokingstatus, size=weeksquit), alpha=0.7) +
  theme_bw() +
  scale_color_manual(name='Smoking status', values = scale_palette) +
  scale_y_continuous(limits = c(-0.14,0.13)) +
  scale_x_continuous(limits = c(-0.18,0.20)) +
  scale_size(range = c(2,8))
)
```

## Discrete serum blood Cotinine levels
```{r pcoa_cotinine, echo=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.width=12}
plot(ggplot() +
  xlab("Axis.1")+
  ylab("Axis.2")+
  theme_bw() +
  geom_point(data=smoker.wu.data[smoker.wu.data$COTININE<1,], aes(Axis.1, Axis.2), size=3, alpha=1, color="black") +
  geom_point(data=smoker.wu.data[smoker.wu.data$COTININE>1,], aes(Axis.1, Axis.2, color=COTININE), size=3, alpha=0.7) +
  scale_y_continuous(limits = c(-0.14,0.13)) +
  scale_x_continuous(limits = c(-0.18,0.20)) +
  scale_color_gradient(low = "blue", high = "red", name = "Cotinine (ng/ml)") +
  scale_size(range = c(2,8))
)
```

### Test group with PERMANOVA (adonis, vegan package)
```{r permanova, echo=FALSE, message=FALSE, warning=FALSE, cache=T}
metadata <- as(sample_data(NYC_HANES), "data.frame")
permanova.res <- data.frame()

for(s in combn(levels(metadata$smokingstatus),2, simplify = FALSE)){
  metadata_2cat <- metadata[metadata$smokingstatus %in% s,]
  distwu_2cat <- phyloseq::distance(subset_samples(NYC_HANES, smokingstatus %in% s), "wunifrac")
  permanova <- vegan::adonis(distwu_2cat ~ smokingstatus + RACE + GENDER + AGEGRP4C + SR_ACTIVE + EDU3CAT + DBTS_NEW, metadata_2cat, parallel = 5)
  permanova.res %<>% bind_rows(data.frame(contrast = stringr::str_c(s, collapse = " vs "), r2=permanova$aov.tab[1,5],pvalue=permanova$aov.tab[1,6])) %>% arrange(pvalue)
}

knitr::kable(permanova.res)
```

#### Three categories
```{r permanova3cat, echo=FALSE, message=FALSE, warning=FALSE, cache=T}
metadata_3cat <- metadata[metadata$smokingstatus %in% c("Cigarette","Never smoker", "Former smoker"),]
distwu_3cat <- phyloseq::distance(subset_samples(NYC_HANES, smokingstatus %in% c("Cigarette","Never smoker", "Former smoker")), "wunifrac")
vegan::adonis(distwu_3cat ~ smokingstatus + RACE + GENDER + AGEGRP4C + SR_ACTIVE + EDU3CAT + DBTS_NEW, metadata_3cat)
```

#### All categories
```{r permanovaallcatÃ², echo=FALSE, message=FALSE, warning=FALSE, cache=T}
vegan::adonis(distwu ~ smokingstatus, metadata)
```

# Differential analysis
<!-- ## Genera reported in previous studies -->
<!-- | Up in smokers | Down in smokers | -->
<!-- | ------------- | --------------- | -->
<!-- | Sterptococcus | Neisseria | -->
<!-- | Eubacterium   | Porphyromonas | -->
<!-- | Megasphera    | Gemella | -->
<!-- | Veilonella    | Capnocytophaga | -->
<!-- | Eikenella	    | Fusobacterium | -->
<!-- | Actinomyces   | Corynebacterium | -->
<!-- | Rothia mucilaginosa |  | -->
<!-- | Bifidobacterium longum |	 | -->
<!-- | Atopobium spp | | -->
<!-- | Haemophilus	| | -->
  
## DESeq2
### Current smokers vs. never smokers univariate
```{r current/never, message=FALSE, cache=TRUE, include=FALSE}
threshold <- 0.05
dds <- DESeq(phyloseq_to_deseq2(NYC_HANES, design = ~ smokingstatus), parallel = TRUE)

## here "Current smoker" is the numerator, "Never smoker" is the denominator in fold-change calculation
res <- DESeq2::results(dds, contrast = c("smokingstatus","Cigarette","Never smoker"))
res.filtered <- res[!is.na(res$padj),]
res.filtered <- res.filtered[res.filtered$padj < threshold,]

## Create a table with the taxonomy of the significant OTUs 
res.tax <- cbind(as.data.frame(res.filtered), as.matrix(tax_table(NYC_HANES)[rownames(res.filtered),]))
dds.taxa <- rownames(res.tax)
res.maxfold <- tapply(res.tax$log2FoldChange, res.tax$Genus, function(x) max(x))
res.maxfold <- sort(res.maxfold, T)
# res.tax["New.ReferenceOTU179","Genus"] <- res.tax["New.ReferenceOTU179","Phylum"] %>% as.character
res.tax$Genus <- factor(as.character(res.tax$Genus), levels = names(res.maxfold))
res.tax$type <- "Current/Never"
res.tax <- res.tax[order(res.tax$log2FoldChange),] 
biosis.tsv <- system.file("extdata","biosis.tsv", package="nychanesmicrobiome", mustWork = TRUE)
biosis <- read.csv(biosis.tsv,header = T, sep = '\t')
```

```{r deseq2_univariate, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
plot(ggplot(right_join(biosis, res.tax, by = c("X1" = "Genus")), aes(log2FoldChange, X1)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=3, aes(color = X2)) + 
  facet_grid(Phylum ~ ., scales = "free", space = "free_y",switch = "y",as.table = T)+
  theme_bw() +
  scale_y_discrete(position = "right") +
  scale_color_discrete(name = "Oxygen requirement")+
  # guides(color=FALSE) + 
  theme(axis.text = element_text(hjust = 0, vjust=0.5, size = 11),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 9),
        axis.title.y = element_blank(),
        strip.background = element_rect(colour = "transparent", fill = "transparent"),
        strip.text.y = element_text(angle = 180)
  )
)
```

### Current smokers vs. never smokers adjusting for confounding
```{r current/never confounding, message=FALSE, cache=TRUE, include=FALSE}
## Counfounders added in the design's formula
dds.conf <- DESeq(phyloseq_to_deseq2(NYC_HANES, design = ~ RACE + GENDER + AGEGRP4C + SR_ACTIVE + EDU3CAT + DBTS_NEW + smokingstatus),parallel = TRUE)
##Use two out of three categories in the contrast variable
res.conf <- results(dds.conf, contrast = c("smokingstatus","Cigarette","Never smoker"), pAdjustMethod = "BH")
res.filtered.conf <- res.conf[!is.na(res.conf$padj),]
res.filtered.conf <- res.filtered.conf[res.filtered.conf$padj < threshold,]

res.tax.conf <- cbind(as.data.frame(res.filtered.conf), as.matrix(tax_table(NYC_HANES)[rownames(res.filtered.conf),]))
res.tax.conf <- res.tax.conf[!is.na(res.tax.conf$Family),]
dds.taxa.conf <- rownames(res.tax.conf)
res.maxfold.conf <- tapply(res.tax.conf$log2FoldChange, res.tax.conf$Genus, function(x) max(x))
res.maxfold.conf <- sort(res.maxfold.conf, T)
res.tax.conf["New.ReferenceOTU148","Genus"] <- "Neisseriaceae"
res.tax.conf["New.ReferenceOTU137","Genus"] <- "Neisseriaceae"
res.tax.conf["New.ReferenceOTU192","Genus"] <- "Pasteurellaceae"

res.tax.conf$Genus <- factor(as.character(res.tax.conf$Genus), levels = names(res.maxfold.conf))
res.tax.conf$type <- "Cigarette/Never + conf"

```

```{r deseq2_multivariate, echo=FALSE,message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
plot(ggplot(right_join(biosis, res.tax.conf, by = c("X1" = "Genus")), aes(log2FoldChange, X1)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=3, aes(color = X2)) + 
  facet_grid(Phylum~., scales = "free", space = "free_y",switch = "y",as.table = T) +
  theme_bw() +
  # guides(color=FALSE) + 
  facet_grid(Phylum~., scales = "free", space = "free_y",switch = "y",as.table = T)+
  scale_y_discrete( position = "right") +
 scale_color_discrete(name = "Oxygen requirement")+
  # guides(color=FALSE) + 
  theme(axis.text = element_text(hjust = 0, vjust=0.5, size = 11),
        strip.text = element_text(size = 9),
        axis.title = element_text(size = 9),
        axis.title.y = element_blank(),
        strip.background = element_rect(colour = "transparent", fill = "transparent"),
        strip.text.y = element_text(angle = 180)
  )
)
```

### Plot univariate vs. multivariate from DESeq2
```{r, message=FALSE, warning=FALSE, cache=TRUE, include=FALSE}
compardat <- data.frame(univariate = res$log2FoldChange, pvalue = res$pvalue, padj = res$padj, multivariate = res.conf$log2FoldChange)
compardat$padj[is.na(compardat$padj)] <- 1
```

```{r deseq2_univ_vs_multiv, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=8, fig.width=12}
ggplot(compardat) +
  geom_point(aes(univariate, multivariate, color=padj < 0.05), size=2) +
  geom_abline() +
  scale_colour_manual(values = setNames(c('#DCDC29','grey'),c(TRUE, FALSE)), guide=FALSE) +
  scale_x_continuous(limits = c(-2,2))+
  scale_y_continuous(limits = c(-2,2))+
  theme_bw() +
  theme( axis.text = element_text(hjust = 0, vjust=0.5, size = 17),
         strip.text = element_text(size = 13),
         axis.title = element_text(size = 15))
```

### Secondhand vs Cigarette/Never
```{r cotinine, message=FALSE, cache=FALSE, include=FALSE, warning=FALSE, cache=FALSE}
NYC_HANEScot <- subset_samples(NYC_HANES, smokingstatus %in% c("Secondhand"))
ddscot <- DESeq(phyloseq_to_deseq2(NYC_HANEScot, design = ~ COTININE), parallel = T)
##Use two out of three categories in the contrast variable
rescot <- results(ddscot, alpha = 0.05)

corr <- cor.test(res$log2FoldChange[res$padj < 0.05], 
                 rescot$log2FoldChange[res$padj < 0.05], 
                 use="pairwise.complete.obs")

cor.data <- data.frame(smoks=res$log2FoldChange[res$padj < 0.05], cot=rescot$log2FoldChange[res$padj < 0.05])
```

```{r deseq2_cotinine_univ, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=8, fig.width=12}
plot(ggplot(cor.data,aes(smoks, cot)) + 
  theme_bw() +
  xlab("Univariate Smokers vs. Non-smokers") +
  ylab("Univariate Cotinine Levels") +
  geom_text(aes(0.5,0.25,label = stringr::str_c('p-value: ',signif(corr$p.value,2), '\nCorr: ', signif(corr$estimate,2))), color="black") +
  geom_point(size=4, color = '#e41a1c') +
  geom_smooth(method=lm, se = FALSE,color="red") +
  scale_x_continuous(limits = c(-1.7,1.7)) +
  scale_y_continuous(limits = c(-0.17,0.3)) +
  theme(axis.text = element_text(hjust = 0, vjust=0.5, size = 13),
        strip.text = element_text(size = 13),
        axis.title = element_text(size = 15))
)
```

## edgeR
### Cigarette smoker vs Never smoker: univariate
```{r edgeR univariate differential analysis, echo=FALSE, cache=TRUE, fig.height=8, fig.width=12}
sample_data(NYC_HANES)$smokingstatus <- relevel(sample_data(NYC_HANES)$smokingstatus,"Never smoker")
da.univ <- get_edgeR_results(~ smokingstatus, coef = 2, alph = 2, filtering = F, method = "BH")
da.univ <- da.univ[sort(da.univ %>% rownames),]
```

```{r edgeR_univ, echo=FALSE, fig.height=8, fig.width=12}
plot((plot_edgeR(~ smokingstatus, pseq = NYC_HANES, coef=2, alph = 0.05, filtering = T, method = "BH", color = "Phylum", sortby = "Phylum") -> edger.univ))
```

### Cigarette smoker vs Never smoker: Multivariate
```{r edgeR multivariate differential analysis, echo=FALSE}
da.multiv <- get_edgeR_results(~ smokingstatus +RACE + GENDER + AGEGRP4C + SR_ACTIVE + EDU3CAT + DBTS_NEW , coef = 2, alph = 2, filtering = F)
da.multiv <- da.multiv[sort(da.multiv %>% rownames),]
```

```{r edgeR_multiv, echo=FALSE, fig.height=8, fig.width=12}
plot((plot_edgeR(~ smokingstatus + RACE + GENDER + AGEGRP4C + SR_ACTIVE + EDU3CAT + DBTS_NEW , coef = 2, pseq = NYC_HANES, alph = 0.05, color = "Phylum", sortby = "Phylum") -> edger.multiv))
```

### Plot univariate vs multivariate beta coefficients
```{r Beta coeff uni vs multi, message=FALSE, warning=FALSE, include=FALSE}
compardat <- data.frame(univariate = da.univ$table$logFC, padj = da.univ$table$PValue, multivariate = da.multiv$table[da.univ$table %>% rownames,]$logFC)
```

```{r edgeR_univ_vs_multiv, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
plot(ggplot(compardat) +
  geom_abline(color="black", alpha=0.5, size=1) +
  geom_point(aes(univariate, multivariate, color=padj < 0.05), size=2) +
  scale_colour_manual(values = setNames(c('grey','#e41a1c'),c(FALSE, TRUE)), guide=FALSE) +
  scale_x_continuous(limits = c(-2,2))+
  scale_y_continuous(limits = c(-2,2))+
  xlab("Univariate Log fold change") +
  ylab("Multivariate Log fold change") +
  theme_bw() +
  theme( axis.text = element_text(hjust = 0, vjust=0.5, size = 15),
         strip.text = element_text(size = 13),
         axis.title = element_text(size = 14))
)
```

### Secondhand vs Cigarette/Never
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
da.cotinine <- get_edgeR_results(~ COTININE, pseq = subset_samples(NYC_HANES, smokingstatus %in% c("Secondhand")), alph = 2, filtering = F, method = "BH")
da.cotinine <- da.cotinine[sort(da.cotinine %>% rownames),]
edger.smoker_secondhand <- data.frame(smokers = da.univ$table[rownames(da.cotinine$table),"logFC"], secondhand = da.cotinine$table$logFC, pvalue = da.univ$table[rownames(da.cotinine$table),"FDR"])

edger.smoker_secondhand<-edger.smoker_secondhand[edger.smoker_secondhand$pvalue<0.05,]

corr <- cor.test(edger.smoker_secondhand$secondhand, edger.smoker_secondhand$smokers,use="pairwise.complete.obs")
```

```{r edger_cotinine_univ, echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
ggplot(edger.smoker_secondhand) + 
  theme_bw() +
  xlab("Univariate Smokers vs. Non-smokers") +
  ylab("Univariate Cotinine Levels") +
  geom_text(aes(1,0.4,label = sprintf("p-value: %s\ncor: %s",signif(corr$p.value,2),signif(corr$estimate,2)))) +
  geom_point(aes(smokers, secondhand, color=pvalue <= 0.05), size=2) +
  scale_colour_manual(values = setNames(c('#e41a1c','grey'),c(TRUE, FALSE)), guide=FALSE) +
  geom_smooth(aes(smokers, secondhand), method=lm, se = FALSE,color="red") +
  theme(axis.text = element_text(hjust = 0, vjust=0.5, size = 13),
        strip.text = element_text(size = 13),
        axis.title = element_text(size = 15))
```

### Alternative smokers vs Never smoker: univariate
```{r edgeR_alternative, echo=FALSE, cache=TRUE, fig.height=8, fig.width=12}
sample_data(NYC_HANES)$smokingstatus <- relevel(sample_data(NYC_HANES)$smokingstatus,"Never smoker")
da.univ <- get_edgeR_results(~ smokingstatus, coef = 4, alph = 2, filtering = F, method = "BH")
da.univ <- da.univ[sort(da.univ %>% rownames),]
plot((plot_edgeR(~ smokingstatus, pseq = NYC_HANES, coef=4, alph = 0.05, filtering = T, method = "BH", color = "Phylum", sortby = "Phylum",invisbl = FALSE)))
```

#### E-cigarette vs never smokers
```{r edgeR_ecigs, echo=FALSE, cache=TRUE, fig.height=8, fig.width=12}
sample_data(NYC_HANES)$ecig <- factor(sample_data(NYC_HANES)$ecig,labels = c('NO','YES'))
# plot((plot_edgeR(~ ecig, pseq = NYC_HANES, alph = 0.05, filtering = T, method = "BH", sortby = "Phylum") -> edger.univ),)
```

#### Hookah pipe vs never smokers
```{r edgeR_hookah, echo=FALSE, cache=TRUE, fig.height=8, fig.width=12}
sample_data(NYC_HANES)$hookah <- factor(sample_data(NYC_HANES)$hookah, labels = c('NO','YES'))
plot_edgeR(~ hookah, pseq = NYC_HANES, alph = 0.05, filtering = T, method = "BH", sortby = "Phylum", color = 'Phylum',invisbl = FALSE)
```

#### Cigars and cigarillos vs never smokers
```{r edgeR_cigars, echo=FALSE, cache=TRUE, fig.height=8, fig.width=12}
sample_data(NYC_HANES)$cigar <- factor(sample_data(NYC_HANES)$cigar,labels = c('NO','YES'))
# plot(plot_edgeR(~ cigar, pseq = NYC_HANES, alph = 0.05, filtering = T, method = "BH", sortby = "Phylum", invisbl = FALSE))
```

# Analysis on biosis of bacteria
## Odds ratio smokers vs never smokers
```{r OR aerobes anares, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
da.univ <- get_edgeR_results(~ smokingstatus, coef = 2, alph = 2, filtering = T, method = "BH")
da.univ$table %<>% left_join(biosis, by = c("Genus"="X1"))
da.univ <- da.univ$table
da.univ$direction <- factor(ifelse(da.univ$logFC >0, 'Enriched in smokers', 'Depleted in smokers'))
da.univ$direction <- factor(da.univ$direction, levels(da.univ$direction)[c(2,1)])

direction <- c('enriched in','depleted in;')

x<- table(da.univ$X2 == 'Aerobic', da.univ$direction)[c(2,1),]
rownames(x) <- c('OTU is aerobic', 'OTU is not aerobic')
epitools::epitab(x)

x<- table(da.univ$X2 == 'Anaerobic', da.univ$direction)[c(2,1),]
rownames(x) <- c('OTU is anaerobic', 'OTU is not anaerobic')
epitools::epitab(x)

x<- table(da.univ$X2 == 'F Anaerobic', da.univ$direction)[c(2,1),]
rownames(x) <- c('OTU is F Anaerobic', 'OTU is not F Anaerobic')
epitools::epitab(x)

```

## GSEA cigarette smokers vs never smokers
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
NYC_HANES.sns <- NYC_HANES %>% subset_samples(., smokingstatus %in% c("Cigarette","Never smoker"))
NYC_HANES.sns %<>% prune_taxa((NYC_HANES.sns %>% otu_table  %>% rowSums())>30,.)
meta <- sample_data(NYC_HANES.sns)
pdata <- new("AnnotatedDataFrame",meta)

group = sample_data(NYC_HANES.sns)$smokingstatus
design = model.matrix(~smokingstatus, data=data.frame(sample_data(NYC_HANES.sns)))

d <- edgeR::DGEList(otu_table(NYC_HANES.sns), group = sample_data(NYC_HANES.sns)$smokingstatus)
d <- edgeR::calcNormFactors(d)
class(d$counts) <- "matrix"
otu_table.voom <- limma::voom(d, design = design, plot = FALSE)

eset <- ExpressionSet(assayData = otu_table.voom$E, phenoData = pdata)
eset$GROUP <- ifelse(eset$smokingstatus == "Cigarette",0,1)
de.eset <- EnrichmentBrowser::de.ana(eset)

par(mfrow=c(1,2))
EnrichmentBrowser::volcano(rowData(de.eset)$FC, rowData(de.eset)$ADJ.PVAL) 
eset.none <- EnrichmentBrowser::de.ana(de.eset, padj.method="none")
EnrichmentBrowser::pdistr(rowData(eset.none)$ADJ.PVAL)

biosis <- read.csv(biosis.tsv,header = T, sep = '\t')
ds <- tax_table(NYC_HANES.sns) %>% as.data.frame %>% bind_cols(data.frame(OTU=rownames(tax_table(NYC_HANES.sns)))) %>% filter(Domain != "Unassigned") %>% left_join(biosis, by = c("Genus"="X1"))
sAero <- (ds %>% filter(X2=="Aerobic"))$OTU %>% as.character
sAnae <- (ds %>% filter(X2=="Anaerobic"))$OTU %>% as.character
sFana <- (ds %>% filter(X2=="F Anaerobic" | X2=="Aero / Facultative Anaerobic"))$OTU %>% as.character
my.gs <- list(aero=sAero, anae=sAnae, fana=sFana)

EnrichmentBrowser::config.ebrowser("OUTDIR.DEFAULT","./results")
gsea.res <- EnrichmentBrowser::sbea("gsea", de.eset, my.gs)
EnrichmentBrowser::gs.ranking(gsea.res, signif.only=FALSE)
```

### Significative OTUs
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
ind <- which(rowData(de.eset)$ADJ.PVAL < 0.05)
tax_table(NYC_HANES.sns)[ind,'Genus']
```

### Most significative OTU
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
ind <- which.min(rowData(de.eset)$ADJ.PVAL)
otuname <- rownames(de.eset)[ind]
smoker.exprs <- assay(de.eset)[ind,de.eset$GROUP==0]
nsmoker.exprs <- assay(de.eset)[ind,de.eset$GROUP==1]
boxplot(nsmoker.exprs, smoker.exprs)
title(paste(otuname, tax_table(NYC_HANES.sns)[otuname,'Genus']))
```

## ORA cigarette smokers vs never smokers
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
ora.res <- EnrichmentBrowser::sbea("ora", de.eset, my.gs, perm=0)
EnrichmentBrowser::gs.ranking(ora.res, signif.only=FALSE)
```

## GSEA secondhand smokers 
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
NYC_HANES.sh <- NYC_HANES %>% subset_samples(., smokingstatus %in% c("Secondhand"))
NYC_HANES.sh %<>% prune_taxa((NYC_HANES.sh %>% otu_table  %>% rowSums())>30,.)

meta <- sample_data(NYC_HANES.sh)
meta$catcotinine <- ifelse(meta$COTININE<3,'low','high')
pdata <- new("AnnotatedDataFrame",meta)

group = meta$catcotinine
design = model.matrix(~catcotinine, data=data.frame(meta))

d = edgeR::DGEList(otu_table(NYC_HANES.sh), group = meta$catcotinine)
d = edgeR::calcNormFactors(d)
otu_table.voom <- voom(d, design = design, plot = FALSE)

eset <- ExpressionSet(assayData = otu_table.voom$E, phenoData = pdata)
eset$GROUP <- ifelse(meta$COTININE < 1.9, 0,ifelse(meta$COTININE>4.35,1,NA))
subeset <- eset[,!is.na(eset$GROUP)]
##TERTILES DIVISION HERE
# quantile(meta$COTININE,c(0.33,0.66))
de.eset <- EnrichmentBrowser::de.ana(subeset)

biosis <- read.csv(biosis.tsv,header = T, sep = '\t')
ds <- tax_table(NYC_HANES.sh) %>% as.data.frame %>% bind_cols(data.frame(OTU=rownames(tax_table(NYC_HANES.sh)))) %>% filter(Domain != "Unassigned") %>% left_join(biosis, by = c("Genus"="X1"))
sAero <- (ds %>% filter(X2=="Aerobic"))$OTU %>% as.character
sAnae <- (ds %>% filter(X2=="Anaerobic"))$OTU %>% as.character
sFana <- (ds %>% filter(X2=="F Anaerobic" | X2=="Aero / Facultative Anaerobic"))$OTU %>% as.character
my.gs <- list(aero=sAero, anae=sAnae, fana=sFana)


EnrichmentBrowser::config.ebrowser("OUTDIR.DEFAULT","./results")
gsea.res <- EnrichmentBrowser::sbea("gsea", de.eset, my.gs)
EnrichmentBrowser::gs.ranking(gsea.res, signif.only=FALSE)
```

## ORA secondhand smokers
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
ora.res <- EnrichmentBrowser::sbea("ora", de.eset, my.gs, perm=0)
EnrichmentBrowser::gs.ranking(ora.res, signif.only=FALSE)

```

## GSVA continuous cotinine on secondhand smokers
```{r continuous, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
NYC_HANES.sh <- NYC_HANES %>% subset_samples(., smokingstatus %in% c("Secondhand"))
NYC_HANES.sh %<>% prune_taxa((NYC_HANES.sh %>% otu_table  %>% rowSums())>30,.)

meta <- sample_data(NYC_HANES.sh)
pdata <- new("AnnotatedDataFrame",meta)
group = meta$COTININE
design = model.matrix(~COTININE, data=data.frame(meta))

d = edgeR::DGEList(otu_table(NYC_HANES.sh), group = meta$COTININE)
d = edgeR::calcNormFactors(d)
otu_table.voom <- voom(d, design = design, plot = FALSE)

eset <- ExpressionSet(assayData = otu_table.voom$E, phenoData = pdata)


biosis <- read.csv(biosis.tsv,header = T, sep = '\t')
ds <- tax_table(NYC_HANES.sh) %>% as.data.frame %>% bind_cols(data.frame(OTU=rownames(tax_table(NYC_HANES.sh)))) %>% filter(Domain != "Unassigned") %>% left_join(biosis, by = c("Genus"="X1"))
sAero <- (ds %>% filter(X2=="Aerobic"))$OTU %>% as.character
sAnae <- (ds %>% filter(X2=="Anaerobic"))$OTU %>% as.character
sFana <- (ds %>% filter(X2=="F Anaerobic" | X2=="Aero / Facultative Anaerobic"))$OTU %>% as.character
my.gs <- list(aero=sAero, anae=sAnae, fana=sFana)

my.gsva <- GSVA::gsva(eset, my.gs, parallel.sz = 1)

fit <- limma::lmFit(my.gsva, my.gsva$COTININE) %>% eBayes()
topTable(fit)
```

## GSVA continuous cotinine on cigarette vs never smokers
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE}
NYC_HANES.sns <- NYC_HANES %>% subset_samples(., smokingstatus %in% c("Cigarette","Never smoker") & !is.na(COTININE))
NYC_HANES.sns %<>% prune_taxa((NYC_HANES.sns %>% otu_table  %>% rowSums())>30,.)

meta <- sample_data(NYC_HANES.sns)
pdata <- new("AnnotatedDataFrame",meta)

design = model.matrix(~COTININE, data=data.frame(meta))

d = edgeR::DGEList(otu_table(NYC_HANES.sns), group = meta$COTININE)
d = edgeR::calcNormFactors(d)
otu_table.voom <- voom(d, design = design)

eset <- ExpressionSet(assayData = otu_table.voom$E, phenoData = pdata)


biosis <- read.csv(biosis.tsv,header = T, sep = '\t')
ds <- tax_table(NYC_HANES.sns) %>% as.data.frame %>% bind_cols(data.frame(OTU=rownames(tax_table(NYC_HANES.sns)))) %>% filter(Domain != "Unassigned") %>% left_join(biosis, by = c("Genus"="X1"))
sAero <- (ds %>% filter(X2=="Aerobic"))$OTU %>% as.character
sAnae <- (ds %>% filter(X2=="Anaerobic"))$OTU %>% as.character
sFana <- (ds %>% filter(X2=="F Anaerobic" | X2=="Aero / Facultative Anaerobic"))$OTU %>% as.character
my.gs <- list(aero=sAero, anae=sAnae, fana=sFana)

my.gsva <- GSVA::gsva(eset, my.gs, parallel.sz = 1)

fit <- limma::lmFit(my.gsva, my.gsva$COTININE) %>% eBayes()
topTable(fit)
```